"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var i in o)Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i])}return t},_createClass=function(){function t(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,o,i){return o&&t(e.prototype,o),i&&t(e,i),e}}(),_domClosest=require("dom-closest"),_domClosest2=_interopRequireDefault(_domClosest),_domMatches=require("dom-matches"),_domMatches2=_interopRequireDefault(_domMatches),_domClasslist=require("dom-classlist"),_domClasslist2=_interopRequireDefault(_domClasslist),_escape=require("lodash/escape"),_escape2=_interopRequireDefault(_escape),_template=require("lodash/template"),_template2=_interopRequireDefault(_template),_debounce=require("lodash/debounce"),_debounce2=_interopRequireDefault(_debounce),BareFoot=function(){function t(){var e=this,o=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t);var i={scope:"body",divFootnotesQuery:".footnotes",footnotesQuery:"[id^='fn']",supQuery:'a[href^="#fnref"]',fnButtonMarkup:'<button class="footnote-button" id="{{FOOTNOTEREFID}}" data-footnote="{{FOOTNOTEID}}" alt="See Footnote {{FOOTNOTENUMBER}}" rel="footnote" data-fn-number="{{FOOTNOTENUMBER}}" data-fn-content="{{FOOTNOTECONTENT}}"></button>',fnContentMarkup:'<div class="bf-footnote" id="{{FOOTNOTEID}}"><div class="footnote-wrapper"><div class="footnote-content" tabindex="0">{{FOOTNOTECONTENT}}</div></div><div class="footnote-tooltip" aria-hidden="true"></div>',activeCallback:null,activeBtnClass:"is-active",activeFnClass:"footnote-is-active",backdropClass:"footnote-backdrop",buttonClass:"footnote-button",fnContainer:"footnote-container",fnClass:"bf-footnote",fnContentClass:"footnote-content",fnWrapperClass:"footnote-wrapper",tooltipClass:"footnote-tooltip",fnOnTopClass:"footnote-is-top"};if(this.config=_extends({},i,o),this.divFootnotes=[].slice.call(document.querySelectorAll(this.config.divFootnotesQuery)),!this.divFootnotes)return!1;this.footnotes=this.divFootnotes.map(function(t){return t.querySelectorAll(e.config.footnotesQuery)});var n=document.createElement("div");n.style.cssText="width: 100px; height: 100px; overflow: scroll; position: absolute; top: -9999px; visibility: hidden;",document.body.appendChild(n),this.scrollBarWidth=n.offsetWidth-n.clientWidth,document.body.removeChild(n)}return _createClass(t,[{key:"removeBackLinks",value:function(t,e){e.indexOf(" ")>=0&&(e=e.trim().replace(/\s+/g,"|").replace(/(.*)/g,"($1)")),0===e.indexOf("#")&&(e=e.slice(1));var o=new RegExp("(\\s|&nbsp;)*<\\s*a[^#<]*#"+e+"[^>]*>(.*?)<\\s*/\\s*a>","g");return t.replace(o,"").replace("[]","")}},{key:"buildButton",value:function(t,e,o,i){return this.config.fnButtonMarkup.replace(/\{\{FOOTNOTEREFID\}\}/g,t).replace(/\{\{FOOTNOTEID\}\}/g,e).replace(/\{\{FOOTNOTENUMBER\}\}/g,o).replace(/\{\{FOOTNOTECONTENT\}\}/g,i)}},{key:"buildContent",value:function(t,e){return this.config.fnContentMarkup.replace(/\{\{FOOTNOTEID\}\}/g,t).replace(/\{\{FOOTNOTECONTENT\}\}/g,e)}},{key:"clickAction",value:function(t){var e=void 0,o=void 0,i=void 0,n=void 0,s=void 0,a=void 0,l=void 0;e=t.target,o=e.getAttribute("data-fn-content"),i=e.getAttribute("data-footnote"),l=(0,_domClasslist2["default"])(e).contains("is-active"),a=this.getScrollHeight(),this.dismissFootnotes(),l||(n=this.buildContent(i,o),e.insertAdjacentHTML("afterend",n),s=e.nextElementSibling,this.calculateOffset(s,e),this.calculateSpacing(s,a),(0,_domClasslist2["default"])(e).add(this.config.activeBtnClass),(0,_domClasslist2["default"])(s).add(this.config.activeFnClass),s.querySelector("."+this.config.fnContentClass).focus(),"ontouchstart"in document.documentElement&&(0,_domClasslist2["default"])(document.body).add(this.config.backdropClass),this.config.activeCallback&&this.config.activeCallback(e,s))}},{key:"calculateOffset",value:function(t,e){var o=void 0,i=void 0,n=void 0,s=void 0,a=void 0,l=void 0,c=void 0,r=void 0,d=void 0,u=void 0,f=void 0,v=void 0;e=e||t.previousElementSibling,n=e.offsetLeft,s=e.offsetWidth,o=t.querySelector("."+this.config.tooltipClass),u=o.clientWidth,i=t.parentNode,a=i.clientWidth,l=i.offsetLeft,c=t.offsetWidth,r=-(c/2-a/2),v=window.innerWidth||window.availWidth,0>l+r?r-=l+r:l+r+c+this.scrollBarWidth>v&&(r-=l+r+c+this.scrollBarWidth+a/2-v),t.style.left=r+"px",d=l+r,f=l-d+a/2-u/2,o.style.left=f+"px"}},{key:"removeFootnoteChild",value:function(t){return t.parentNode.removeChild(t)}},{key:"resizeAction",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);e.length&&[].forEach.call(e,function(e){t.calculateOffset(e),t.calculateSpacing(e)})}},{key:"getScrollHeight",value:function(){return document.documentElement.scrollHeight}},{key:"calculateSpacing",value:function(t,e){var o=void 0,i=void 0,n=void 0,s=void 0,a=void 0;s=this.calculateMargins(t),a=window.innerHeight||window.availHeight,o=t.getBoundingClientRect(),i=o.height,n=o.bottom,e<this.getScrollHeight()||n>a-s.bottom?(0,_domClasslist2["default"])(t).add(this.config.fnOnTopClass):a-(i+s.top)>n&&(0,_domClasslist2["default"])(t).contains(this.config.fnOnTopClass)&&(0,_domClasslist2["default"])(t).remove(this.config.fnOnTopClass)}},{key:"scrollAction",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);if(e.length){window.innerHeight||window.availHeight,this.calculateMargins(e[0]);[].forEach.call(e,function(e){t.calculateSpacing(e)})}}},{key:"calculateMargins",value:function(t){var e=window.getComputedStyle(t,null);return{top:parseFloat(e.marginTop),right:parseFloat(e.marginRight),bottom:parseFloat(e.marginBottom),left:parseFloat(e.marginLeft)}}},{key:"documentAction",value:function(t){(0,_domClosest2["default"])(t.target,"."+this.config.fnContainer)||this.dismissFootnotes()}},{key:"dismissOnEsc",value:function(t){return 27===t.keyCode&&(0,_domMatches2["default"])(document.activeElement,"."+this.config.fnContentClass)?((0,_domClosest2["default"])(document.activeElement,"."+this.config.activeFnClass).previousElementSibling.focus(),this.dismissFootnotes()):void 0}},{key:"dismissFootnotes",value:function(){var t=this,e=document.querySelectorAll("."+this.config.activeFnClass);e.length&&[].forEach.call(e,function(e){(0,_domClasslist2["default"])(e.previousElementSibling).remove(t.config.activeBtnClass),e.addEventListener("transitionend",t.removeFootnoteChild(e),!1),(0,_domClasslist2["default"])(e).remove(t.config.activeFnClass)}),(0,_domClasslist2["default"])(document.body).contains(this.config.backdropClass)&&(0,_domClasslist2["default"])(document.body).remove(this.config.backdropClass)}},{key:"init",value:function(){var t=this;[].forEach.call(this.footnotes,function(e,o){var i=(0,_domClosest2["default"])(e[0],t.config.scope);[].forEach.call(e,function(e,o){var n=void 0,s=void 0,a=void 0,l=void 0,c=void 0;l=o+1,s=e.querySelector(t.config.supQuery).getAttribute("href"),n=t.removeBackLinks(e.innerHTML.trim(),s),n=n.replace(/"/g,"&quot;").replace(/&lt;/g,"&ltsym;").replace(/&gt;/g,"&gtsym;"),0!==n.indexOf("<")&&(n="<p>"+n+"</p>"),a=i.querySelector(s.replace(":","\\:")),c='<div class="'+t.config.fnContainer+'">'+t.buildButton(s,e.id,l,n)+"</div>",a.insertAdjacentHTML("afterend",c),a.parentNode.removeChild(a)})}),[].forEach.call(document.querySelectorAll("."+this.config.buttonClass),function(e){e.addEventListener("click",t.clickAction.bind(t))}),window.addEventListener("resize",(0,_debounce2["default"])(this.resizeAction.bind(this),100)),window.addEventListener("scroll",(0,_debounce2["default"])(this.scrollAction.bind(this),100)),window.addEventListener("keyup",this.dismissOnEsc.bind(this)),document.body.addEventListener("click",this.documentAction.bind(this)),document.body.addEventListener("touchend",this.documentAction.bind(this)),this.divFootnotes.forEach(function(t){return t.parentNode.removeChild(t)})}}]),t}();