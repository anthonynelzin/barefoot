"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,o,n){return o&&t(e.prototype,o),n&&t(e,n),e}}(),LittleFoot=function(){function t(){var e=this,o=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t);var n={scope:"body",divFootnotesQuery:".footnotes",footnotesQuery:"[id^='fn']",fnButtonMarkup:'<button class="footnote-button" id="{{FOOTNOTEREFID}}" data-footnote="{{FOOTNOTEID}}" alt="See Footnote {{FOOTNOTENUMBER}}" rel="footnote" data-fn-number="{{FOOTNOTENUMBER}}" data-fn-content="{{FOOTNOTECONTENT}}"></button>',fnContentMarkup:'<div class="littlefoot-footnote" id="{{FOOTNOTEID}}"><div class="footnote-wrapper"><div class="footnote-content" tabindex=\'0\'>{{FOOTNOTECONTENT}}</div></div><div class="footnote-tooltip" aria-hidden="true"></div>'};return this.config=Object.assign({},n,o),this.divFootnotes=[].slice.call(document.querySelectorAll(this.config.divFootnotesQuery)),this.divFootnotes?(this.footnotes=this.divFootnotes.map(function(t){return t.querySelectorAll(e.config.footnotesQuery)}),Element.prototype.matches=Element.prototype.matches||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(t){return-1!==[].indexOf.call(document.querySelectorAll(t),this)},void(Element.prototype.closest=Element.prototype.closest||function(t){for(var e=this;null!==e;){var o=e.parentElement;if(null!==o&&o.matches(t))return o;e=o}return null})):!1}return _createClass(t,[{key:"init",value:function(){this.footnoteButtonsBuilder(this.actionSetup)}},{key:"removeBackLinks",value:function(t,e){var o=void 0;return e.indexOf(" ")>=0&&(e=e.trim().replace(/\s+/g,"|").replace(/(.*)/g,"($1)")),0===e.indexOf("#")&&(e=e.slice(1)),o=new RegExp("(\\s|&nbsp;)*<\\s*a[^#<]*#"+e+"[^>]*>(.*?)<\\s*/\\s*a>","g"),t.replace(o,"").replace("[]","")}},{key:"buildButton",value:function(t,e,o,n){return this.config.fnButtonMarkup.replace(/\{\{FOOTNOTEREFID\}\}/g,t).replace(/\{\{FOOTNOTEID\}\}/g,e).replace(/\{\{FOOTNOTENUMBER\}\}/g,o).replace(/\{\{FOOTNOTECONTENT\}\}/g,n)}},{key:"buildContent",value:function(t,e){return this.config.fnContentMarkup.replace(/\{\{FOOTNOTEID\}\}/g,t).replace(/\{\{FOOTNOTECONTENT\}\}/g,e)}},{key:"clickAction",value:function(t){var e=void 0,o=void 0,n=void 0,i=void 0,c=void 0;e=t.target,o=e.getAttribute("data-fn-content"),n=e.getAttribute("data-footnote"),e.nextElementSibling?this.removeFootnotes():(this.removeFootnotes(),i=this.buildContent(n,o),e.insertAdjacentHTML("afterend",i),c=e.nextElementSibling,this.calculateOffset(c,e),this.calculateSpacing(c),e.classList.add("is-active"),c.classList.add("footnote-is-active"),c.querySelector(".footnote-content").focus(),"ontouchstart"in document.documentElement&&document.body.classList.add("footnote-backdrop"))}},{key:"calculateOffset",value:function(t,e){var o=void 0,n=void 0,i=void 0,c=void 0,a=void 0,l=void 0,r=void 0,s=void 0,u=void 0,d=void 0,f=void 0,v=void 0;e=e||t.previousElementSibling,i=e.offsetLeft,c=e.offsetWidth,o=t.querySelector(".footnote-tooltip"),d=o.clientWidth,n=t.parentNode,a=n.clientWidth,l=n.offsetLeft,r=t.offsetWidth,s=-(r/2-a/2),v=window.innerWidth||window.availWidth,0>l+s?s-=l+s:l+s+r>v&&(s-=l+s+r+a/2-v),t.style.left=s+"px",u=l+s,f=l-u+a/2-d/2,o.style.left=f+"px"}},{key:"removeFootnoteChild",value:function(t){return t.parentNode.removeChild(t)}},{key:"debounce",value:function(t,e,o){var n;return function(){for(var i=this,c=arguments.length,a=Array(c),l=0;c>l;l++)a[l]=arguments[l];var r=function(){n=null,o||t.apply(i,a)};clearTimeout(n),n=setTimeout(r,e),o&&!n&&t.apply(this,a)}}},{key:"resizeAction",value:function(){var t=this,e=document.querySelectorAll(".footnote-is-active");e.length&&[].forEach.call(e,function(){t.calculateOffset(fn),t.calculateSpacing(fn)})}},{key:"calculateSpacing",value:function(t){var e=void 0,o=void 0,n=void 0,i=void 0,c=void 0;i=this.calculateMargins(t),c=window.innerHeight||window.availHeight,e=t.getBoundingClientRect(),o=e.height,n=e.bottom,n>c-i.bottom?t.classList.add("footnote-is-top"):c-(o+i.top)>n&&t.classList.contains("footnote-is-top")&&t.classList.remove("footnote-is-top")}},{key:"scrollAction",value:function(){var t=this,e=document.querySelectorAll(".footnote-is-active");if(e.length){window.innerHeight||window.availHeight,this.calculateMargins(e[0]);[].forEach.call(e,function(e){t.calculateSpacing(e)})}}},{key:"calculateMargins",value:function(t){var e=window.getComputedStyle(t,null);return{top:parseFloat(e.marginTop),right:parseFloat(e.marginRight),bottom:parseFloat(e.marginBottom),left:parseFloat(e.marginLeft)}}},{key:"documentAction",value:function(t){t.target.closest(".footnote-container")||this.removeFootnotes()}},{key:"removeFootnotes",value:function(){var t=this,e=document.querySelectorAll(".footnote-is-active");e.length&&[].forEach.call(e,function(e){e.previousElementSibling.classList.remove("is-active"),e.addEventListener("transitionend",t.removeFootnoteChild(e),!1),e.classList.remove("footnote-is-active")}),document.body.classList.contains("footnote-backdrop")&&document.body.classList.remove("footnote-backdrop")}},{key:"footnoteButtonsBuilder",value:function(t){var e=this;[].forEach.call(this.footnotes,function(t,o){var n=t[0].closest(e.config.scope);[].forEach.call(t,function(t,o){var i=void 0,c=void 0,a=void 0,l=void 0,r=void 0;l=o+1,c=t.querySelector('a[href^="#fnref"]').getAttribute("href"),i=e.removeBackLinks(t.innerHTML.trim(),c),i=i.replace(/"/g,"&quot;").replace(/&lt;/g,"&ltsym;").replace(/&gt;/g,"&gtsym;"),0!==i.indexOf("<")&&(i="<p>"+i+"</p>"),a=n.querySelector(c.replace(":","\\:")),r='<div class="footnote-container">'+e.buildButton(c,t.id,l,i)+"</div>",a.insertAdjacentHTML("afterend",r),a.parentNode.removeChild(a)})}),t.bind(this)()}},{key:"actionSetup",value:function(){var t=this,e=document.querySelectorAll(".footnote-button");[].forEach.call(e,function(e){e.addEventListener("click",t.clickAction.bind(t))}),window.addEventListener("resize",this.debounce(this.resizeAction.bind(this),100)),window.addEventListener("scroll",this.debounce(this.scrollAction.bind(this),100)),document.body.addEventListener("click",this.documentAction.bind(this)),document.body.addEventListener("touchend",this.documentAction.bind(this)),window.addEventListener("keyup",function(e){27===e.keyCode&&document.activeElement.matches(".footnote-content")&&(document.activeElement.closest(".footnote-is-active").previousElementSibling.focus(),t.removeFootnotes())}),this.divFootnotes.forEach(function(t){return t.parentNode.removeChild(t)})}}]),t}();